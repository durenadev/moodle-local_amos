define("local_amos/translator",["exports","core/ajax","core/config","core/notification","core/pubsub","./filter_events","./translator_events","core/templates","core/modal_events","core/modal_factory","core/str"],(function(_exports,_ajax,_config,_notification,PubSub,_filter_events,_translator_events,_templates,_modal_events,_modal_factory,_str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * JS module for the AMOS translator.
   *
   * @module      local_amos/translator
   * @copyright   2020 David Mudr√°k <david@moodle.com>
   * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_config=_interopRequireDefault(_config),_notification=_interopRequireDefault(_notification),PubSub=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(PubSub),_filter_events=_interopRequireDefault(_filter_events),_translator_events=_interopRequireDefault(_translator_events),_templates=_interopRequireDefault(_templates),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory);_exports.init=()=>{registerEventListeners(),turnAllMissingForEditing(),PubSub.subscribe(_filter_events.default.submit,(filterquery=>{showFilteredStrings(filterquery)}))};const registerEventListeners=()=>{let root=document.getElementById("amostranslator");root.addEventListener("click",(e=>{if(e.target.classList.contains("amostranslation")||e.target.classList.contains("amostranslationview")){let item=e.target.closest('[data-region="amostranslatoritem"].translatable');if("view"==item.getAttribute("data-mode"))return void translatorItemEditingOn(item,e.ctrlKey).focus()}if(e.target.hasAttribute("data-region")&&"timelinelink"==e.target.getAttribute("data-region")){let item=e.target.closest('[data-region="amostranslatoritem"]');return e.preventDefault(),void showTimeline(item)}if(e.target.hasAttribute("data-region")&&"markuptodatelink"==e.target.getAttribute("data-region")){let item=e.target.closest('[data-region="amostranslatoritem"]');return e.preventDefault(),void markUpToDate(item)}let paginatorlink=e.target.closest("[data-paginatorlink]");paginatorlink&&(e.preventDefault(),PubSub.publish(_translator_events.default.pagechange,paginatorlink.getAttribute("data-paginatorlink")))})),root.addEventListener("blur",(e=>{e.target.hasAttribute("data-region")&&"amoseditor"==e.target.getAttribute("data-region")&&translatorItemSave(e.target)}),!0)},translatorItemEditingOn=function(item){let nocleaning=arguments.length>1&&void 0!==arguments[1]&&arguments[1],tabIndex=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,textarea=item.querySelector('[data-region="amoseditor"]'),refHeight=item.querySelector(".amostranslation").clientHeight;return item.setAttribute("data-nocleaning",nocleaning?"1":"0"),textarea.setAttribute("data-previous",textarea.value),tabIndex>0&&(textarea.tabIndex=tabIndex),refHeight>40&&(textarea.style.height=refHeight-9+"px"),item.setAttribute("data-mode","edit"),textarea},translatorItemSave=textarea=>{let item=textarea.closest('[data-region="amostranslatoritem"]'),nocleaning=item.getAttribute("data-nocleaning"),previoustext=textarea.getAttribute("data-previous"),newtext=textarea.value;return"1"!==nocleaning&&(newtext=newtext.trim()),previoustext===newtext&&"1"!==nocleaning?(textarea.value=previoustext,item.setAttribute("data-mode","view"),Promise.resolve(!1)):(item.classList.add("staged"),item.classList.remove("outdated"),textarea.disabled=!0,stageTranslatedString(item,newtext).then((response=>{var _item$querySelector;return item.setAttribute("data-mode","view"),textarea.disabled=!1,textarea.removeAttribute("data-previous"),textarea.innerHTML=textarea.value=response.translation,item.querySelector('[data-region="amostranslationview"]').innerHTML=response.displaytranslation,item.querySelector('[data-region="displaytranslationsince"]').innerHTML=response.displaytranslationsince+" | ",null===(_item$querySelector=item.querySelector('[data-region="markuptodatelink"]'))||void 0===_item$querySelector||_item$querySelector.remove(),!0})).catch(_notification.default.exception))},stageTranslatedString=(item,text)=>(0,_ajax.call)([{methodname:"local_amos_stage_translated_string",args:{stageid:_config.default.sesskey,originalid:item.getAttribute("data-originalid"),lang:item.getAttribute("data-language"),text:text,translationid:parseInt(item.getAttribute("data-translationid"))||0,nocleaning:item.getAttribute("data-nocleaning")}}])[0],turnAllMissingForEditing=()=>{document.getElementById("amostranslator").querySelectorAll(':scope [data-region="amostranslatoritem"].translatable.missing').forEach(((item,index)=>{translatorItemEditingOn(item,!1,index+1)}))},showFilteredStrings=filterQuery=>{let root=document.getElementById("amostranslator"),loadingIndicator=document.getElementById("amosfilter_loading_indicator");return root.classList.add("loading"),(0,_ajax.call)([{methodname:"local_amos_get_translator_data",args:{filterquery:filterQuery}}])[0].then((response=>{try{let data=JSON.parse(response.json);return _templates.default.render("local_amos/translator_root",data)}catch(error){return Promise.reject(error)}})).then((function(html){let js=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return _templates.default.replaceNodeContents(root,html,js)})).then((()=>(turnAllMissingForEditing(),loadingIndicator.classList.add("hidden"),root.classList.remove("loading"),!0))).catch(_notification.default.exception)},showTimeline=item=>{let modalTitle="";return(0,_ajax.call)([{methodname:"local_amos_get_string_timeline",args:{component:item.getAttribute("data-component"),language:item.getAttribute("data-language"),strname:item.getAttribute("data-stringid")}}])[0].then((response=>(modalTitle=(0,_str.get_string)("timelineheading","local_amos",response),_templates.default.render("local_amos/timeline",response)))).then((html=>_modal_factory.default.create({large:!0,title:modalTitle,body:html}))).then((modal=>(modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal.show(),modal))).catch(_notification.default.exception)},markUpToDate=item=>(0,_ajax.call)([{methodname:"local_amos_make_translation_uptodate",args:{originalid:item.getAttribute("data-originalid"),translationid:item.getAttribute("data-translationid")}}])[0].then((response=>{item.classList.remove("outdated"),item.setAttribute("data-translationid",response.translationid),item.querySelector('[data-region="displaytranslationsince"]').innerHTML=response.displaytranslationsince+" | ",item.querySelector('[data-region="markuptodatelink"]').remove()})).catch(_notification.default.exception)}));

//# sourceMappingURL=translator.min.js.map